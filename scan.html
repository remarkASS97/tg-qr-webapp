<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>QR Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root {
      --bg: #000;
      --fg: #fff;
      --ok: #32d74b;
      --shadow: rgba(0, 0, 0, 0.75);
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: var(--bg);
      color: var(--fg);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }

    #reader {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
    }

    #status {
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 12px);
      z-index: 20;
      min-height: 24px;
      text-align: center;
      font-size: 15px;
      line-height: 1.3;
      text-shadow: 0 1px 2px var(--shadow);
      pointer-events: none;
    }

    .status-ok { color: var(--ok); }

    #reader__dashboard,
    #reader__header_message {
      display: none !important;
    }

    #reader__scan_region {
      width: 100% !important;
      height: 100% !important;
      background: #000 !important;
      display: flex !important;
      align-items: center;
      justify-content: center;
    }

    #reader video {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
    }
  </style>
</head>
<body>
  <div id="reader"></div>
  <div id="status">Инициализация камеры...</div>

  <script>
    const tg = window.Telegram?.WebApp;
    const statusEl = document.getElementById("status");

    if (!tg) throw new Error("Telegram WebApp API is not available");

    tg.ready();
    tg.expand();

    const minSide = Math.min(window.innerWidth, window.innerHeight);
    const box = Math.max(190, Math.min(300, Math.floor(minSide * 0.62)));

    const config = {
      fps: 20,
      qrbox: { width: box, height: box },
      aspectRatio: 1,
      disableFlip: true
    };

    const qr = new Html5Qrcode("reader");
    let locked = false;
    let lastSent = "";
    let closed = false;
    let scanned = false;

    function setStatus(text, ok = false) {
      statusEl.textContent = text;
      statusEl.classList.toggle("status-ok", ok);
    }

    function normalizeCode(text) {
      let s = String(text || "");
      s = s.replace(/[\uFEFF\u200B\u2060\u00A0]/g, "");
      s = s.replace(/[–—−‑‒]/g, "-");
      return s.trim();
    }

    function sendToBot(rawText) {
      const value = normalizeCode(rawText);
      if (!value || value === lastSent) return false;
      lastSent = value;
      scanned = true;
      tg.sendData(JSON.stringify({ value }));
      setStatus("QR отправлен", true);
      return true;
    }

    function forceCloseWebApp() {
      if (closed) return;
      closed = true;
      [0, 120, 350].forEach((t) => {
        setTimeout(() => {
          try { tg.close(); } catch (_) {}
        }, t);
      });
    }

    function cleanupNativeEvents(onClosed, onQr) {
      try { tg.offEvent?.("scanQrPopupClosed", onClosed); } catch (_) {}
      try { tg.offEvent?.("qrTextReceived", onQr); } catch (_) {}
    }

    // 1) Приоритет: нативный сканер Telegram
    function startTelegramNativeScanner() {
      if (typeof tg.showScanQrPopup !== "function") return false;

      setStatus("Наведите QR в рамку");

      const onPopupClosed = () => {
        cleanupNativeEvents(onPopupClosed, onQrTextReceived);
        // Нажали "Отмена" -> сразу закрыть mini app, без второго экрана
        if (!scanned) forceCloseWebApp();
      };

      const onQrTextReceived = (event) => {
        const text = event?.data || event;
        const sent = sendToBot(text);
        if (!sent) return;

        cleanupNativeEvents(onPopupClosed, onQrTextReceived);
        try { tg.closeScanQrPopup?.(); } catch (_) {}
        forceCloseWebApp();
      };

      tg.onEvent?.("scanQrPopupClosed", onPopupClosed);
      tg.onEvent?.("qrTextReceived", onQrTextReceived);

      tg.showScanQrPopup({ text: "Сканируйте QR" });
      return true;
    }

    // 2) Fallback: html5-qrcode
    async function startWebCameraScanner() {
      setStatus("Наведите QR в рамку");

      await qr.start(
        { facingMode: { ideal: "environment" } },
        config,
        (decodedText) => {
          if (locked || closed) return;
          locked = true;

          const sent = sendToBot(decodedText);
          if (!sent) {
            locked = false;
            return;
          }

          qr.stop().catch(() => {}).finally(() => forceCloseWebApp());
        },
        () => {}
      );
    }

    (async () => {
      try {
        if (startTelegramNativeScanner()) return;
        await startWebCameraScanner();
      } catch (err) {
        setStatus("Ошибка камеры: " + (err?.message || String(err)));
      }
    })();
  </script>
</body>
</html>
